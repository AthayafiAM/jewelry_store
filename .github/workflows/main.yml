name: Deploy to Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

steps:
  - name: Test version
    run: echo "VERSION 3"

  - name: Checkout repository
    uses: actions/checkout@v3

  - name: Start Docker daemon on WSL
    run: |
      nohup sudo dockerd > /dev/null 2>&1 &
      sleep 5

  - name: Docker info
    run: docker info

  - name: Pull latest images
    run: docker compose pull || true

  - name: Stop existing containers
    run: docker compose down || true

  - name: Build images
    run: docker compose build --no-cache

  - name: Start containers
    run: docker compose up -d

  - name: Check running containers
    run: docker ps -a
